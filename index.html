<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urbex Map Priv√©e</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* -- Style Panneau Admin -- */
        #adminPanel {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 15px; display: none;
            border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
            max-width: 300px;
        }

        /* -- Style Boite de Connexion -- */
        #authContainer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; background: white; padding: 30px;
            border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            text-align: center; width: 300px;
        }
        #authContainer input {
            display: block; width: 100%; margin-bottom: 10px; padding: 10px;
            box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;
        }
        #userInfo {
            position: absolute; bottom: 10px; left: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9); padding: 8px 12px;
            border-radius: 4px; font-size: 13px; display: none;
        }
        
        /* Boutons */
        .btn { border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; color: white; margin-top:5px; }
        .btn-login { background: #007bff; }
        .btn-signup { background: #28a745; } /* Vert pour l'inscription */
        .btn-logout { background: #dc3545; width: auto; font-size: 12px; padding: 5px 10px; }
    </style>
</head>
<body>

    <div id="authContainer">
        <h2>Acc√®s Restreint</h2>
        <input type="email" id="emailInput" placeholder="Votre email">
        <input type="password" id="passInput" placeholder="Mot de passe">
        <button class="btn btn-login" id="btnLogin">Se connecter</button>
        <button class="btn btn-signup" id="btnSignup">Cr√©er un compte</button>
        <p id="authError" style="color: red; font-size: 0.9em; margin-top: 10px;"></p>
    </div>

    <div id="adminPanel">
        <h3>üïµÔ∏è Admin Zone</h3>
        <p>Ajouter un fichier KML :</p>
        <input type="file" id="kmlInput" accept=".kml">
        <p id="status" style="color: blue; font-size: 0.9em; margin-bottom:0;"></p>
    </div>

    <div id="userInfo">
        <span id="userEmailDisplay"></span>
        <button class="btn btn-logout" id="btnLogout">D√©co</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDOBN0gJwIbrZFOymSwP9BnzNudubPorkU",
            authDomain: "urbex-map-b907d.firebaseapp.com",
            projectId: "urbex-map-b907d",
            storageBucket: "urbex-map-b907d.firebasestorage.app",
            messagingSenderId: "91725857148",
            appId: "1:91725857148:web:fa7545a9dbbd075a6be4f9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. CARTE ---
        const map = L.map('map').setView([46.603354, 1.888334], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        // --- 3. AUTHENTIFICATION ---
        const ADMIN_EMAIL = "enzocomyn@protonmail.com";
        const authContainer = document.getElementById('authContainer');
        const userInfo = document.getElementById('userInfo');
        const adminPanel = document.getElementById('adminPanel');

        // Surveiller l'√©tat de connexion
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Si connect√©
                authContainer.style.display = 'none'; // Cacher le formulaire
                userInfo.style.display = 'block';
                document.getElementById('userEmailDisplay').innerText = user.email;
                
                console.log("Connect√© :", user.email);
                chargerLesSpots(); // Charger la carte

                // V√©rif Admin
                if(user.email === ADMIN_EMAIL) {
                    adminPanel.style.display = 'block';
                    activerImportKML();
                } else {
                    adminPanel.style.display = 'none';
                }
            } else {
                // Si pas connect√©
                authContainer.style.display = 'block'; // Montrer le formulaire
                userInfo.style.display = 'none';
                adminPanel.style.display = 'none';
            }
        });

        // Bouton Connexion
        document.getElementById('btnLogin').addEventListener('click', () => {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passInput').value;
            signInWithEmailAndPassword(auth, email, pass)
                .catch((error) => {
                    document.getElementById('authError').innerText = "Erreur : " + error.message;
                });
        });

        // Bouton Inscription
        document.getElementById('btnSignup').addEventListener('click', () => {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passInput').value;
            createUserWithEmailAndPassword(auth, email, pass)
                .then(() => {
                    alert("Compte cr√©√© ! Vous √™tes connect√©.");
                })
                .catch((error) => {
                    document.getElementById('authError').innerText = "Erreur cr√©ation : " + error.message;
                });
        });

        // Bouton D√©connexion
        document.getElementById('btnLogout').addEventListener('click', () => {
            signOut(auth);
        });

        // --- 4. IMPORT KML (Admin) ---
        function activerImportKML() {
            const input = document.getElementById('kmlInput');
            const newItem = input.cloneNode(true);
            input.parentNode.replaceChild(newItem, input);
            
            newItem.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                document.getElementById('status').innerText = "Lecture...";
                const reader = new FileReader();
                reader.onload = function(e) { sauvegarderSpot(file.name, e.target.result); };
                reader.readAsText(file);
            });
        }

        async function sauvegarderSpot(nom, kmlData) {
            try {
                document.getElementById('status').innerText = "Envoi...";
                await addDoc(collection(db, "spots"), {
                    nom: nom, kml: kmlData, uploadedAt: new Date(), auteur: ADMIN_EMAIL
                });
                document.getElementById('status').innerText = "‚úÖ Import√© !";
                chargerLesSpots();
            } catch (e) {
                console.error(e);
                document.getElementById('status').innerText = "‚ùå Erreur (Permissions)";
            }
        }

        // --- 5. CHARGEMENT ---
        async function chargerLesSpots() {
            try {
                const querySnapshot = await getDocs(collection(db, "spots"));
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.kml) {
                        const layer = omnivore.kml.parse(data.kml);
                        layer.on('ready', function() {
                            this.eachLayer(function(l) { l.bindPopup(`<b>${data.nom}</b>`); });
                        });
                        layer.addTo(map);
                    }
                });
            } catch (e) { console.error("Erreur chargement:", e); }
        }
    </script>
</body>
</html>
